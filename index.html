<!DOCTYPE html>
<html>
<head>
  <title>Map with Osentar Gexico Flag</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    .flag-overlay {
      position: absolute;
      pointer-events: none;
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      z-index: 1000;
      opacity: 0.9;
      transition: opacity 0.3s ease;
    }
  </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const mapWidth = 18657;
  const mapHeight = 18658;

  const map = L.map('map', {
    crs: L.CRS.Simple,
    minZoom: -5,
    maxZoom: 4,
    zoomSnap: 0.1
  });

  const bounds = [[0, 0], [mapHeight, mapWidth]];
  L.imageOverlay('BIG MAP.png', bounds).addTo(map);
  map.fitBounds(bounds);

  let currentMarker = null;
  let flagDiv = null;
  let activePolygon = null;

  function latLngToLayerPointArray(latlngs) {
    return latlngs.map(latlng => map.latLngToLayerPoint(latlng));
  }

  function createFlagOverlay(polygon, flagUrl) {
    const mapPane = map.getPane('overlayPane');
    const layerPoints = latLngToLayerPointArray(polygon.getLatLngs()[0]);

    let minX = layerPoints[0].x, minY = layerPoints[0].y;
    let maxX = minX, maxY = minY;

    layerPoints.forEach(pt => {
      if (pt.x < minX) minX = pt.x;
      if (pt.y < minY) minY = pt.y;
      if (pt.x > maxX) maxX = pt.x;
      if (pt.y > maxY) maxY = pt.y;
    });

    const width = maxX - minX;
    const height = maxY - minY;

    const clipPathPoints = layerPoints.map(pt => {
      return `${pt.x - minX}px ${pt.y - minY}px`;
    }).join(', ');

    if (!flagDiv) {
      flagDiv = L.DomUtil.create('div', 'flag-overlay', mapPane);
    }

    flagDiv.style.left = `${minX}px`;
    flagDiv.style.top = `${minY}px`;
    flagDiv.style.width = `${width}px`;
    flagDiv.style.height = `${height}px`;
    flagDiv.style.backgroundImage = `url(${flagUrl})`;
    flagDiv.style.clipPath = `polygon(${clipPathPoints})`;
    flagDiv.style.WebkitClipPath = `polygon(${clipPathPoints})`;
    flagDiv.style.opacity = '0.9';
  }

  function removeFlagOverlay() {
    if (flagDiv) {
      flagDiv.style.opacity = '0';
      setTimeout(() => {
        if (flagDiv && flagDiv.parentNode) {
          flagDiv.parentNode.removeChild(flagDiv);
          flagDiv = null;
        }
      }, 300);
    }
  }

  map.on('zoom move', function () {
    if (activePolygon && flagDiv) {
      createFlagOverlay(activePolygon, 'Osentar_flag.gif');
    }
  });

  fetch('map_polygons.geojson')
    .then(res => res.json())
    .then(data => {
      L.geoJSON(data, {
        style: feature => ({
          color: 'black',
          weight: 1,
          fillOpacity: 0,
          opacity: 0
        }),
        onEachFeature: (feature, layer) => {
          // Add click link if provided
          if (feature.properties && feature.properties.link) {
            layer.on('click', () => {
              window.open(feature.properties.link, '_blank');
            });
          }

          // Only show flag overlay for Osentar Gexico
          if (feature.properties && feature.properties.name === 'Osentar Gexico') {
            layer.on('mouseover', () => {
              activePolygon = layer;
              createFlagOverlay(layer, 'Osentar_flag.gif');
            });

            layer.on('mouseout', () => {
              activePolygon = null;
              removeFlagOverlay();
            });
          }
        }
      }).addTo(map);
    });
</script>

</body>
</html>
